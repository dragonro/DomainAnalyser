<!DOCTYPE html>
<html class="dark" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Domain Report</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1173d4",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
            },
            fontFamily: {
              display: ["Inter"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
    </style>
  </head>
  <body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200">
    <div class="flex min-h-screen flex-col">
      <header class="sticky top-0 z-10 border-b border-gray-200/50 dark:border-gray-700/50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex h-16 items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="flex items-center gap-2 text-primary">
                <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5-10-5-10 5z"></path>
                </svg>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">Domain Analyser</h1>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <nav class="hidden md:flex items-center gap-6">
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors" href="/">Analyse</a>
                <a class="text-sm font-bold text-primary dark:text-primary" href="#">Reports</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors" href="#">Settings</a>
              </nav>
              <button id="print-report" class="inline-flex items-center gap-2 rounded-full p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-800" type="button">
                <span class="material-symbols-outlined">print</span>
              </button>
              <div class="flex h-9 w-9 items-center justify-center rounded-full bg-primary/10 text-primary font-semibold uppercase">DA</div>
            </div>
          </div>
        </div>
      </header>
      <main class="flex-grow">
        <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
          <div id="report-alert" class="hidden rounded-lg border border-red-300/40 bg-red-100/60 px-4 py-3 text-sm text-red-900"></div>
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Domain Report</p>
              <h2 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white" id="report-domain">Loading...</h2>
              <p class="mt-1 text-sm text-gray-600 dark:text-gray-400" id="report-timestamp"></p>
            </div>
            <button id="back-to-insights" class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-primary/90" type="button">
              <span class="material-symbols-outlined">arrow_back</span>
              Back to Insights
            </button>
          </div>

          <section class="mt-8 rounded-xl border border-gray-200 dark:border-gray-800 bg-background-light dark:bg-background-dark shadow-sm">
            <div class="p-6">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Recent Reports</h3>
                <span class="text-sm text-gray-500 dark:text-gray-400" id="recent-report-count">--</span>
              </div>
              <div class="mt-4 overflow-x-auto rounded-lg border border-gray-200/60 dark:border-gray-700/60">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
                  <thead class="bg-gray-50 dark:bg-gray-800/40 text-gray-600 dark:text-gray-300 uppercase tracking-wide text-xs">
                    <tr>
                      <th class="px-4 py-3 text-left">Domain</th>
                      <th class="px-4 py-3 text-left">Last Checked</th>
                      <th class="px-4 py-3 text-left">Status</th>
                      <th class="px-4 py-3 text-left">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="recent-reports-table" class="divide-y divide-gray-200 dark:divide-gray-800 bg-background-light dark:bg-background-dark">
                    <tr>
                      <td class="px-4 py-4 text-sm text-gray-500 dark:text-gray-400" colspan="4">Fetching recent reports...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-4">
            <article class="rounded-xl border border-gray-200 dark:border-gray-800 bg-background-light dark:bg-background-dark shadow-sm p-6 lg:col-span-1">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Email & Productivity</h3>
              <dl class="mt-4 space-y-3 text-sm">
                <div class="flex justify-between">
                  <dt class="text-gray-500 dark:text-gray-400">Email Provider</dt>
                  <dd class="font-medium text-gray-900 dark:text-gray-100" id="report-email">--</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-gray-500 dark:text-gray-400">Productivity Suite</dt>
                  <dd class="font-medium text-gray-900 dark:text-gray-100" id="report-productivity">--</dd>
                </div>
              </dl>
            </article>
            <article class="rounded-xl border border-gray-200 dark:border-gray-800 bg-background-light dark:bg-background-dark shadow-sm p-6 lg:col-span-1">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Hosting / Networks</h3>
              <ul class="mt-4 space-y-2 text-sm" id="report-networks">
                <li class="text-gray-500 dark:text-gray-400">Detecting network providers...</li>
              </ul>
            </article>
            <article class="rounded-xl border border-gray-200 dark:border-gray-800 bg-background-light dark:bg-background-dark shadow-sm p-6 lg:col-span-2">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Apex DNS Records</h3>
              <div class="mt-4 space-y-4" id="report-records">
                <p class="text-sm text-gray-500 dark:text-gray-400">Loading records...</p>
              </div>
            </article>
          </section>

          <section class="mt-8 rounded-xl border border-gray-200 dark:border-gray-800 bg-background-light dark:bg-background-dark shadow-sm">
            <div class="p-6">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Subdomain Findings</h3>
                <span class="text-sm text-gray-500 dark:text-gray-400" id="report-subdomain-count">--</span>
              </div>
              <div class="mt-4 overflow-x-auto rounded-lg border border-gray-200/60 dark:border-gray-700/60">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
                  <thead class="bg-gray-50 dark:bg-gray-800/40 text-gray-600 dark:text-gray-300 uppercase tracking-wide text-xs">
                    <tr>
                      <th class="px-4 py-3 text-left">Subdomain</th>
                      <th class="px-4 py-3 text-left">Email Provider</th>
                      <th class="px-4 py-3 text-left">Productivity</th>
                      <th class="px-4 py-3 text-left">Network / CDN</th>
                      <th class="px-4 py-3 text-left">Records</th>
                    </tr>
                  </thead>
                  <tbody id="report-subdomain-table" class="divide-y divide-gray-200 dark:divide-gray-800 bg-background-light dark:bg-background-dark">
                    <tr>
                      <td class="px-4 py-4" colspan="5">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </div>
      </main>
      <footer class="border-t border-gray-200/60 dark:border-gray-700/60">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between text-sm text-gray-500 dark:text-gray-400">
          <span>Copyright - DualBytes x Possibl.</span>
          <span class="sm:text-right">Version 0.4</span>
        </div>
      </footer>
    </div>
    <script>
      const params = new URLSearchParams(window.location.search);
      const domain = params.get("domain");
      const alertBox = document.getElementById("report-alert");
      const domainHeading = document.getElementById("report-domain");
      const timestampEl = document.getElementById("report-timestamp");
      const emailEl = document.getElementById("report-email");
      const productivityEl = document.getElementById("report-productivity");
      const recordsEl = document.getElementById("report-records");
      const subdomainTableEl = document.getElementById("report-subdomain-table");
      const subdomainCountEl = document.getElementById("report-subdomain-count");
      const networksEl = document.getElementById("report-networks");
      const recentReportCountEl = document.getElementById("recent-report-count");
      const recentReportsTableEl = document.getElementById("recent-reports-table");
      const backButton = document.getElementById("back-to-insights");
      const printButton = document.getElementById("print-report");

      function showAlert(message) {
        alertBox.textContent = message;
        alertBox.className = "rounded-lg border border-red-300/40 bg-red-100/60 px-4 py-3 text-sm text-red-900";
      }

      function renderRecords(records) {
        if (!records || Object.keys(records).length === 0) {
          return `<p class=\"text-sm text-gray-500 dark:text-gray-400\">No DNS records available.</p>`;
        }
        return Object.entries(records)
          .map(([type, values]) => {
            const list = values
              .map(value => `<li class=\"rounded-lg border border-gray-200 dark:border-gray-700 bg-white/40 dark:bg-gray-800/40 px-3 py-2\">${value}</li>`)
              .join("\n");
            return `<div><p class=\"text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400\">${type}</p><ul class=\"mt-2 space-y-2\">${list}</ul></div>`;
          })
          .join("\n");
      }

      function renderRecentReports(reports) {
        if (!reports || reports.length === 0) {
          recentReportCountEl.textContent = "0 stored";
          recentReportsTableEl.innerHTML = `<tr><td class=\"px-4 py-4 text-sm text-gray-500 dark:text-gray-400\" colspan=\"4\">No reports saved yet. Run a lookup to populate this list.</td></tr>`;
          return;
        }

        recentReportCountEl.textContent = `${reports.length} stored, last 10 shown`;
        recentReportsTableEl.innerHTML = reports.slice(0, 10)
          .map(report => {
            const statusBadge = report.exists
              ? `<span class=\"inline-flex items-center rounded-full bg-primary/10 px-2.5 py-0.5 text-xs font-medium text-primary dark:bg-primary/20 dark:text-primary\">Verified</span>`
              : `<span class=\"inline-flex items-center rounded-full bg-red-100/80 px-2.5 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900/40 dark:text-red-300\">Unavailable</span>`;
            const lookedUp = new Date(report.looked_up_at).toLocaleString();
            const domainLink = `report.html?domain=${encodeURIComponent(report.domain)}`;
            return `<tr>
                <td class=\"px-4 py-4 font-medium text-gray-900 dark:text-white\">
                  <a class=\"hover:text-primary dark:hover:text-primary transition-colors\" href=\"${domainLink}\">${report.domain}</a>
                </td>
                <td class=\"px-4 py-4 text-gray-600 dark:text-gray-300\">${lookedUp}</td>
                <td class=\"px-4 py-4\">${statusBadge}</td>
                <td class=\"px-4 py-4\">
                  <div class=\"flex items-center gap-4\">
                    <a class=\"text-primary hover:underline\" href=\"${domainLink}\">View</a>
                    <button class=\"text-primary hover:underline\" data-domain=\"${report.domain}\">Reload</button>
                  </div>
                </td>
              </tr>`;
          })
          .join("\n");

        recentReportsTableEl.querySelectorAll('button[data-domain]').forEach(button => {
          button.addEventListener('click', event => {
            const selectedDomain = event.currentTarget.getAttribute('data-domain');
            if (selectedDomain) {
              window.location.href = `report.html?domain=${encodeURIComponent(selectedDomain)}`;
            }
          });
        });
      }

      function renderNetworkPanel(networks) {
        if (!networksEl) {
          return;
        }
        if (!networks || networks.length === 0) {
          networksEl.innerHTML = `<li class=\"text-gray-500 dark:text-gray-400\">No major network or CDN detected.</li>`;
          return;
        }

        networksEl.innerHTML = networks
          .map(name => `<li class=\"flex items-center gap-2\"><span class=\"inline-flex h-2 w-2 rounded-full bg-primary\"></span><span>${name}</span></li>`)
          .join("\n");
      }

      function renderSubdomains(subdomains) {
        if (!subdomains || subdomains.length === 0) {
          subdomainCountEl.textContent = "0 found";
          subdomainTableEl.innerHTML = `<tr><td class=\"px-4 py-4 text-sm text-gray-500 dark:text-gray-400\" colspan=\"5\">No subdomains detected from the current wordlist.</td></tr>`;
          return;
        }
        subdomainCountEl.textContent = `${subdomains.length} found`;
        subdomainTableEl.innerHTML = subdomains
          .map(sub => {
            const records = Object.keys(sub.records)
              .map(type => `<span class=\"inline-flex items-center rounded-full bg-gray-200 dark:bg-gray-700 px-2 py-0.5 text-xs font-medium text-gray-700 dark:text-gray-200\">${type}</span>`)
              .join(" ");
            const networks = (sub.networks || [])
              .map(name => `<span class=\"inline-flex items-center rounded-full bg-primary/10 px-2 py-0.5 text-xs font-medium text-primary dark:bg-primary/20 dark:text-primary\">${name}</span>`)
              .join(" ");
            return `<tr>
                <td class=\"px-4 py-4 font-medium text-gray-900 dark:text-white\">${sub.fqdn}</td>
                <td class=\"px-4 py-4 text-gray-600 dark:text-gray-300\">${sub.providers.email}</td>
                <td class=\"px-4 py-4 text-gray-600 dark:text-gray-300\">${sub.providers.productivity}</td>
                <td class=\"px-4 py-4\"><div class=\"flex flex-wrap gap-2\">${networks || '--'}</div></td>
                <td class=\"px-4 py-4\"><div class=\"flex flex-wrap gap-2\">${records || "--"}</div></td>
              </tr>`;
          })
          .join("\n");
      }

      async function loadRecentReports() {
        try {
          const response = await fetch('/api/reports?limit=50');
          if (!response.ok) {
            throw new Error('Failed to load reports');
          }
          const reports = await response.json();
          renderRecentReports(reports);
        } catch (error) {
          recentReportCountEl.textContent = 'Error';
          recentReportsTableEl.innerHTML = `<tr><td class=\"px-4 py-4 text-sm text-red-500\">Unable to load stored reports.</td></tr>`;
        }
      }

      async function loadReport() {
        if (!domain) {
          domainHeading.textContent = "Reports";
          timestampEl.textContent = "Select a domain from the list below.";
          emailEl.textContent = "--";
          productivityEl.textContent = "--";
          recordsEl.innerHTML = `<p class=\"text-sm text-gray-500 dark:text-gray-400\">Select a saved report to view apex DNS records.</p>`;
          renderNetworkPanel([]);
          subdomainCountEl.textContent = "0 found";
          subdomainTableEl.innerHTML = `<tr><td class=\"px-4 py-4 text-sm text-gray-500 dark:text-gray-400\" colspan=\"5\">Choose a domain from recent reports to view detailed findings.</td></tr>`;
          return;
        }

        domainHeading.textContent = domain;
        timestampEl.textContent = new Date().toLocaleString();

        try {
          const response = await fetch(`/api/reports/${encodeURIComponent(domain)}`);
          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            showAlert(payload.detail || "Unable to generate report for this domain.");
            renderNetworkPanel([]);
            return;
          }

          const payload = await response.json();
          emailEl.textContent = payload.providers.email;
          productivityEl.textContent = payload.providers.productivity;
          recordsEl.innerHTML = renderRecords(payload.apex_records);
          renderNetworkPanel(payload.networks);
          renderSubdomains(payload.subdomains);
        } catch (error) {
          showAlert("A network error occurred while generating the report.");
          renderNetworkPanel([]);
        }
      }

      backButton.addEventListener("click", () => {
        if (domain) {
          window.location.href = `insight.html?domain=${encodeURIComponent(domain)}`;
        } else {
          window.location.href = "index.html";
        }
      });

      printButton.addEventListener("click", () => window.print());

      loadRecentReports();
      loadReport();
    </script>
  </body>
</html>
