<!DOCTYPE html>
<html class="dark" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Domain Analyser</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="/app-config.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1173d4",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
            },
            fontFamily: {
              display: ["Inter"],
            },
            borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
    </style>
  </head>
  <body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200">
    <div class="flex min-h-screen w-full flex-col">
      <header class="border-b border-primary/20 dark:border-primary/30">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center gap-4">
              <a class="flex items-center gap-2" href="/">
                <svg class="h-6 w-6 text-primary" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2L2 7V17L12 22L22 17V7L12 2ZM4 8.5L12 13.5L20 8.5L12 4L4 8.5Z"></path>
                </svg>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">Domain Analyser</h1>
              </a>
            </div>
            <div class="flex items-center gap-4">
              <nav class="hidden md:flex items-center gap-6">
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors" href="/">Analyse</a>
                <a class="text-sm font-medium text-primary dark:text-primary" href="#">Reports</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors" href="#">Settings</a>
              </nav>
              <button class="md:hidden p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-800">
                <span class="material-symbols-outlined"> menu </span>
              </button>
              <div class="flex h-9 w-9 items-center justify-center rounded-full bg-primary/10 text-primary font-semibold uppercase">DA</div>
            </div>
          </div>
        </div>
      </header>
      <main class="flex-1 px-4 py-8 sm:px-6 lg:px-8">
        <div class="mx-auto max-w-7xl space-y-8">
          <div id="insight-alert" class="hidden rounded-lg border border-yellow-300/40 bg-yellow-100/60 px-4 py-3 text-sm text-yellow-900"></div>
          <div class="flex flex-col items-start justify-between gap-4 md:flex-row md:items-center">
            <div>
              <p class="text-xs font-medium text-gray-500 dark:text-gray-400">DNS Report</p>
              <h2 class="text-3xl font-bold text-gray-900 dark:text-white" id="domain-title">Loading...</h2>
            </div>
            <button id="download-report" class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm transition-all hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-background-dark" type="button">
              <span class="material-symbols-outlined"> history </span>
              Scan History
            </button>
          </div>
          <div class="grid grid-cols-1 gap-8 lg:grid-cols-5">
            <section class="space-y-6 lg:col-span-2">
              <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-background-light dark:bg-background-dark shadow-sm">
                <div class="p-6 space-y-4">
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Main Domain</h3>
                  <div class="flex justify-between">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Domain</p>
                    <p class="text-sm font-medium text-gray-800 dark:text-gray-200" id="apex-domain">--</p>
                  </div>
                  <div class="flex justify-between">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Email Provider</p>
                    <p class="text-sm font-medium text-gray-800 dark:text-gray-200" id="email-provider">--</p>
                  </div>
                  <div class="flex justify-between">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Productivity</p>
                    <p class="text-sm font-medium text-gray-800 dark:text-gray-200" id="productivity-suite">--</p>
                  </div>
                </div>
              </div>
              <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-background-light dark:bg-background-dark shadow-sm">
                <div class="p-6 space-y-4">
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Hosting / Networks</h3>
                  <ul class="space-y-2 text-sm" id="hosting-networks">
                    <li class="text-gray-500 dark:text-gray-400">Detecting network providers...</li>
                  </ul>
                </div>
              </div>
              <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-background-light dark:bg-background-dark shadow-sm">
                <div class="p-6 space-y-4">
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Apex DNS Records</h3>
                  <div class="space-y-3" id="apex-records">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Loading records...</p>
                  </div>
                </div>
              </div>
            </section>
            <section class="lg:col-span-3 space-y-6">
              <div class="rounded-xl border border-gray-200 dark:border-gray-800 bg-background-light dark:bg-background-dark shadow-sm">
                <div class="p-6 space-y-4">
                  <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Subdomains</h3>
                    <span id="subdomain-count" class="text-sm text-gray-500 dark:text-gray-400">--</span>
                  </div>
                  <div class="overflow-x-auto rounded-lg border border-gray-200/60 dark:border-gray-700/60">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
                      <thead class="bg-gray-50 dark:bg-gray-800/40 text-gray-600 dark:text-gray-300 uppercase tracking-wide text-xs">
                        <tr>
                          <th class="px-4 py-3 text-left">Subdomain</th>
                          <th class="px-4 py-3 text-left">Email Provider</th>
                          <th class="px-4 py-3 text-left">Productivity</th>
                          <th class="px-4 py-3 text-left">Network / CDN</th>
                          <th class="px-4 py-3 text-left">Records</th>
                        </tr>
                      </thead>
                      <tbody id="subdomain-table" class="divide-y divide-gray-200 dark:divide-gray-800 bg-background-light dark:bg-background-dark">
                        <tr>
                          <td class="px-4 py-4" colspan="5">Loading subdomains...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </main>
      <footer class="border-t border-gray-200/60 dark:border-gray-700/60">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between text-sm text-gray-500 dark:text-gray-400">
          <span>Copyright - DualBytes x Possibl.</span>
          <span class="sm:text-right">Version 0.5</span>
        </div>
      </footer>
    </div>
    <script>
      const params = new URLSearchParams(window.location.search);
      const domain = params.get("domain");
      const alertEl = document.getElementById("insight-alert");
      const domainTitle = document.getElementById("domain-title");
      const apexDomain = document.getElementById("apex-domain");
      const emailProvider = document.getElementById("email-provider");
      const productivitySuite = document.getElementById("productivity-suite");
      const apexRecordsContainer = document.getElementById("apex-records");
      const subdomainTable = document.getElementById("subdomain-table");
      const subdomainCount = document.getElementById("subdomain-count");
      const hostingNetworksContainer = document.getElementById("hosting-networks");
      const downloadButton = document.getElementById("download-report");
      //const buildApiUrl = window.appApiUrl || (path => (path.startsWith('/') ? path : `/${path}`));        
      const buildApiUrl = path => `${window.location.origin}${path.startsWith('/') ? path : `/${path}`}`;

      function showAlert(message, tone = "warning") {
        const toneClasses = {
          warning: "border-yellow-300/40 bg-yellow-100/60 text-yellow-900",
          danger: "border-red-300/40 bg-red-100/60 text-red-900",
        };
        alertEl.textContent = message;
        alertEl.className = `rounded-lg px-4 py-3 text-sm ${toneClasses[tone] || toneClasses.warning}`;
      }

      function clearAlert() {
        alertEl.textContent = "";
        alertEl.className = "hidden";
      }

      function renderRecordList(records) {
        if (!records || Object.keys(records).length === 0) {
          return `<p class="text-sm text-gray-500 dark:text-gray-400">No DNS records were located.</p>`;
        }
        return Object.entries(records)
          .map(([rType, values]) => {
            const chips = values
              .map(value => `<span class=\"inline-flex items-center rounded-full bg-primary/10 px-2 py-0.5 text-xs font-medium text-primary dark:bg-primary/20\">${value}</span>`)
              .join(" ");
            return `<div><p class=\"text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400\">${rType}</p><div class=\"mt-1 flex flex-wrap gap-2\">${chips}</div></div>`;
          })
          .join("\n");
      }

      function renderNetworkList(networks) {
        if (!hostingNetworksContainer) {
          return;
        }
        if (!networks || networks.length === 0) {
          hostingNetworksContainer.innerHTML = `<li class=\"text-gray-500 dark:text-gray-400\">No major network or CDN detected.</li>`;
          return;
        }

        hostingNetworksContainer.innerHTML = networks
          .map(name => `<li class=\"flex items-center gap-2\"><span class=\"inline-flex h-2 w-2 rounded-full bg-primary\"></span><span>${name}</span></li>`)
          .join("\n");
      }

      function renderSubdomains(subdomains) {
        if (!subdomains || subdomains.length === 0) {
          subdomainCount.textContent = "0 found (but there may be more)";
          subdomainTable.innerHTML = `<tr><td class=\"px-4 py-4 text-sm text-gray-500 dark:text-gray-400\" colspan=\"5\">No subdomains matched the current wordlist.</td></tr>`;
          return;
        }

        subdomainCount.textContent = `${subdomains.length} found`;
        subdomainTable.innerHTML = subdomains
          .map(sub => {
            const records = Object.keys(sub.records)
              .map(type => `<span class=\"inline-flex items-center rounded-full bg-gray-200 dark:bg-gray-700 px-2 py-0.5 text-xs font-medium text-gray-700 dark:text-gray-200\">${type}</span>`)
              .join(" ");
            const networks = (sub.networks || [])
              .map(name => `<span class=\"inline-flex items-center rounded-full bg-primary/10 px-2 py-0.5 text-xs font-medium text-primary dark:bg-primary/20 dark:text-primary\">${name}</span>`)
              .join(" ");
            return `<tr>
                <td class=\"px-4 py-4 font-medium text-gray-900 dark:text-white\">${sub.fqdn}</td>
                <td class=\"px-4 py-4 text-gray-600 dark:text-gray-300\">${sub.providers.email}</td>
                <td class=\"px-4 py-4 text-gray-600 dark:text-gray-300\">${sub.providers.productivity}</td>
                <td class=\"px-4 py-4\"><div class=\"flex flex-wrap gap-2\">${networks || '--'}</div></td>
                <td class=\"px-4 py-4\"><div class=\"flex flex-wrap gap-2\">${records || "--"}</div></td>
              </tr>`;
          })
          .join("\n");
      }

      async function loadInsights() {
        if (!domain) {
          domainTitle.textContent = "Domain missing";
          showAlert("No domain was provided. Return to the dashboard and try again.");
          subdomainTable.innerHTML = "";
          renderNetworkList([]);
          return;
        }

        clearAlert();
        domainTitle.textContent = domain;
        apexDomain.textContent = domain;
        downloadButton.addEventListener("click", () => {
          window.location.href = `report.html?domain=${encodeURIComponent(domain)}`;
        });

      try {
          const response = await fetch(buildApiUrl(`/api/domains/${encodeURIComponent(domain)}?include_subdomains=true`));
          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            showAlert(errorPayload.detail || "Domain analysis failed.", "danger");
            apexRecordsContainer.innerHTML = "";
            subdomainTable.innerHTML = "";
            renderNetworkList([]);
            return;
          }

          const payload = await response.json();
          apexDomain.textContent = payload.domain;
          emailProvider.textContent = payload.providers.email;
          productivitySuite.textContent = payload.providers.productivity;
          apexRecordsContainer.innerHTML = renderRecordList(payload.apex_records);
          renderNetworkList(payload.networks);
          renderSubdomains(payload.subdomains);
        } catch (error) {
          showAlert("A network error occurred while retrieving insights.", "danger");
          apexRecordsContainer.innerHTML = "";
          subdomainTable.innerHTML = "";
          renderNetworkList([]);
        }
      }

      loadInsights();
    </script>
  </body>
</html>
